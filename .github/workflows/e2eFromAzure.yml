name: e2e tests

on: 
  push:
    branches:
      - main
  pull_request:
  repository_dispatch:
    types: [azure_devops_trigger]

jobs:
  # Post pending status to Azure DevOps
  post-pending-status:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Post Pending Status to Azure DevOps
        run: |
          echo "üì§ Posting pending status to Azure DevOps..."
          
          AZURE_ORG="${{ github.event.client_payload.azure_organization }}"
          AZURE_PROJECT="${{ github.event.client_payload.azure_project }}"
          REPO_ID="${{ github.event.client_payload.azure_repository_id }}"
          COMMIT_SHA="${{ github.event.client_payload.commit_sha }}"
          PR_ID="${{ github.event.client_payload.azure_pull_request_id }}"
          
          # Preparar el payload base
          BASE_PAYLOAD='{
            "state": "pending",
            "description": "GitHub Actions E2E tests are running...",
            "context": {
              "name": "GitHub-E2E-Tests",
              "genre": "continuous-integration"
            },
            "targetUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'
          
          # Intentar postear a PR primero (si existe PR_ID)
          if [ -n "$PR_ID" ] && [ "$PR_ID" != "null" ]; then
            echo "üìç Posting to PR #$PR_ID..."
            
            HTTP_STATUS=$(curl -w "%{http_code}" -o pr_response.json \
              -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
              "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/pullRequests/${PR_ID}/statuses?api-version=7.1" \
              -d "$BASE_PAYLOAD")
            
            echo "PR Status HTTP: $HTTP_STATUS"
            cat pr_response.json
            
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
              echo "‚úÖ PR status posted successfully"
              exit 0
            else
              echo "‚ö†Ô∏è PR status failed, trying commit status..."
            fi
          else
            echo "‚ö†Ô∏è No PR ID, posting to commit only"
          fi
          
          # Fallback: Postear a commit level (siempre funciona)
          echo "üìç Posting to commit $COMMIT_SHA..."
          
          HTTP_STATUS=$(curl -w "%{http_code}" -o commit_response.json \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
            "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/commits/${COMMIT_SHA}/statuses?api-version=7.1" \
            -d "$BASE_PAYLOAD")
          
          echo "Commit Status HTTP: $HTTP_STATUS"
          cat commit_response.json
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Commit status posted successfully"
          else
            echo "‚ö†Ô∏è Failed to post status, but continuing..."
          fi

  # Run actual tests
  test:
    needs: post-pending-status
    if: always()  # Run even if status post failed
    uses: ./.github/workflows/split-local.yml
    secrets:
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    with:
      nE2E: 2
      marge: true
      browser: chrome
      before-run: npm run stop-only
      publish-summary: true
      split-file: timings.json

  # Report results back to Azure DevOps
  report-to-azure:
    needs: test
    if: always() && github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Determine Test Result
        id: test_result
        run: |
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "state=succeeded" >> $GITHUB_OUTPUT
            echo "description=All E2E tests passed ‚úÖ" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" = "failure" ]; then
            echo "state=failed" >> $GITHUB_OUTPUT
            echo "description=E2E tests failed ‚ùå" >> $GITHUB_OUTPUT
          else
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=E2E tests encountered an error ‚ö†Ô∏è" >> $GITHUB_OUTPUT
          fi
      
      - name: Post Final Status to Azure DevOps
        continue-on-error: true
        run: |
          echo "üì§ Posting final status to Azure DevOps..."
          
          AZURE_ORG="${{ github.event.client_payload.azure_organization }}"
          AZURE_PROJECT="${{ github.event.client_payload.azure_project }}"
          REPO_ID="${{ github.event.client_payload.azure_repository_id }}"
          COMMIT_SHA="${{ github.event.client_payload.commit_sha }}"
          PR_ID="${{ github.event.client_payload.azure_pull_request_id }}"
          
          # Preparar el payload base
          BASE_PAYLOAD='{
            "state": "${{ steps.test_result.outputs.state }}",
            "description": "${{ steps.test_result.outputs.description }}",
            "context": {
              "name": "GitHub-E2E-Tests",
              "genre": "continuous-integration"
            },
            "targetUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'
          
          # Intentar postear a PR primero (si existe PR_ID)
          if [ -n "$PR_ID" ] && [ "$PR_ID" != "null" ]; then
            echo "üìç Posting to PR #$PR_ID..."
            
            HTTP_STATUS=$(curl -w "%{http_code}" -o pr_response.json \
              -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
              "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/pullRequests/${PR_ID}/statuses?api-version=7.1" \
              -d "$BASE_PAYLOAD")
            
            echo "PR Status HTTP: $HTTP_STATUS"
            cat pr_response.json
            
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
              echo "‚úÖ PR status posted successfully"
              # No exit aqu√≠, continuar para postear tambi√©n a commit
            else
              echo "‚ö†Ô∏è PR status failed"
            fi
          fi
          
          # SIEMPRE postear a commit level (para que aparezca en el repo)
          echo "üìç Posting to commit $COMMIT_SHA..."
          
          HTTP_STATUS=$(curl -w "%{http_code}" -o commit_response.json \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
            "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/commits/${COMMIT_SHA}/statuses?api-version=7.1" \
            -d "$BASE_PAYLOAD")
          
          echo "Commit Status HTTP: $HTTP_STATUS"
          cat commit_response.json
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Status posted successfully to Azure DevOps"
          else
            echo "‚ùå Failed to post status to Azure DevOps"
            echo "Response:"
            cat commit_response.json
            # No fallar aqu√≠, solo advertir
          fi
      
      - name: Fail if Tests Failed
        if: steps.test_result.outputs.state != 'succeeded'
        run: |
          echo "‚ùå Tests failed - marking job as failed"
          exit 1