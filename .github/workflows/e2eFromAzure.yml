name: e2e tests

on: 
  push:
    branches:
      - main
  pull_request:
  repository_dispatch:
    types: [azure_devops_trigger]

jobs:
  post-pending-status:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Post Pending Status
        run: |
          echo "üì§ Posting pending status..."
          
          AZURE_ORG="${{ github.event.client_payload.azure_organization }}"
          AZURE_PROJECT="${{ github.event.client_payload.azure_project }}"
          REPO_ID="${{ github.event.client_payload.azure_repository_id }}"
          COMMIT_SHA="${{ github.event.client_payload.commit_sha }}"
          
          # Construir JSON con jq
          PAYLOAD=$(jq -n \
            --arg state "pending" \
            --arg desc "GitHub Actions E2E tests running..." \
            --arg name "GitHub-E2E-Tests" \
            --arg genre "continuous-integration" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              state: $state,
              description: $desc,
              context: {
                name: $name,
                genre: $genre
              },
              targetUrl: $url
            }')
          
          echo "Payload:"
          echo "$PAYLOAD" | jq .
          
          # Post a commit status (siempre funciona)
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
            "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/commits/${COMMIT_SHA}/statuses?api-version=7.1" \
            -d "$PAYLOAD")
          
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Status: $HTTP_STATUS"
          echo "Response:"
          echo "$BODY" | jq . || echo "$BODY"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Status posted"
          else
            echo "‚ö†Ô∏è Failed, but continuing..."
          fi

  test:
    needs: post-pending-status
    if: always()
    uses: ./.github/workflows/split-local.yml
    secrets:
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
    with:
      nE2E: 2
      marge: true
      browser: chrome
      before-run: npm run stop-only
      publish-summary: true
      split-file: timings.json

  report-to-azure:
    needs: test
    if: always() && github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Determine Result
        id: result
        run: |
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "state=succeeded" >> $GITHUB_OUTPUT
            echo "desc=All E2E tests passed ‚úÖ" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" = "failure" ]; then
            echo "state=failed" >> $GITHUB_OUTPUT
            echo "desc=E2E tests failed ‚ùå" >> $GITHUB_OUTPUT
          else
            echo "state=error" >> $GITHUB_OUTPUT
            echo "desc=Tests error ‚ö†Ô∏è" >> $GITHUB_OUTPUT
          fi
      
      - name: Post Final Status to Azure DevOps
        continue-on-error: true
        run: |
          echo "üì§ Posting final status..."
          
          AZURE_ORG="${{ github.event.client_payload.azure_organization }}"
          AZURE_PROJECT="${{ github.event.client_payload.azure_project }}"
          REPO_ID="${{ github.event.client_payload.azure_repository_id }}"
          COMMIT_SHA="${{ github.event.client_payload.commit_sha }}"
          
          # Construir JSON con jq
          PAYLOAD=$(jq -n \
            --arg state "${{ steps.result.outputs.state }}" \
            --arg desc "${{ steps.result.outputs.desc }}" \
            --arg name "GitHub-E2E-Tests" \
            --arg genre "continuous-integration" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              state: $state,
              description: $desc,
              context: {
                name: $name,
                genre: $genre
              },
              targetUrl: $url
            }')
          
          echo "Payload:"
          echo "$PAYLOAD" | jq .
          
          # Post a commit status
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_TOKEN }}" | base64)" \
            "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${REPO_ID}/commits/${COMMIT_SHA}/statuses?api-version=7.1" \
            -d "$PAYLOAD")
          
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Status: $HTTP_STATUS"
          echo "Response:"
          echo "$BODY" | jq . || echo "$BODY"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Status posted to Azure"
          else
            echo "‚ùå Failed to post"
          fi
      
      - name: Fail if Tests Failed
        if: steps.result.outputs.state != 'succeeded'
        run: exit 1